<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Échecs Multijoueur</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .game-container { display: flex; gap: 20px; max-width: 1400px; width: 100%; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .chess-board-container { padding: 20px; flex: 1; }
        .game-info { background: #f8f9fa; padding: 20px; width: 350px; border-left: 1px solid #dee2e6; }
        
        /* Conteneur principal centré */
        .chess-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        /* Conteneur échiquier + coordonnées */
        .chess-board-with-coords {
            position: relative;
            display: inline-block;
        }
        
        /* Échiquier avec pièces Unicode améliorées */
        .chess-board { 
            width: 500px; 
            height: 500px; 
            border: 3px solid #8b4513; 
            border-radius: 8px; 
            display: grid; 
            grid-template-columns: repeat(8, 1fr); 
            grid-template-rows: repeat(8, 1fr); 
        }
        
        .square { 
            width: 62.5px; 
            height: 62.5px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 45px; 
            cursor: pointer; 
            position: relative; 
            transition: all 0.2s ease; 
        }
        
        /* Coordonnées des files (a-h) en bas */
        .file-coords {
            display: flex;
            width: 500px;
            height: 20px;
            justify-content: space-around;
            align-items: center;
            margin-top: 5px;
            font-weight: bold;
            font-size: 14px;
            color: #8b4513;
            user-select: none;
        }

        .file-label {
            width: 62.5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Coordonnées des rangs (1-8) à droite */
        .rank-coords {
            position: absolute;
            right: -25px;
            top: 0;
            display: flex;
            flex-direction: column;
            height: 500px;
            width: 20px;
            justify-content: space-around;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            color: #8b4513;
            user-select: none;
        }

        .rank-label {
            height: 62.5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Thèmes d'échiquier */
        .board-classic .light { background-color: #f0d9b5; }
        .board-classic .dark { background-color: #b58863; }
        
        .board-green .light { background-color: #eeeed2; }
        .board-green .dark { background-color: #769656; }
        
        .board-blue .light { background-color: #dee3e6; }
        .board-blue .dark { background-color: #8ca2ad; }
        
        .board-wood .light { background-color: #f3e4c9; }
        .board-wood .dark { background-color: #c19a6b; }
        
        .board-marble .light { background-color: #efefef; }
        .board-marble .dark { background-color: #8a8a8a; }
        
        .board-pink .light { background-color: #ffe6f0; }
        .board-pink .dark { background-color: #ffb3d9; }
        
        .board-purple .light { background-color: #e6e0ff; }
        .board-purple .dark { background-color: #9999ff; }
        
        .board-metal .light { background-color: #e0e0e0; }
        .board-metal .dark { background-color: #606060; }
        
        .board-ocean .light { background-color: #b3e5fc; }
        .board-ocean .dark { background-color: #0288d1; }
        
        .board-forest .light { background-color: #c8e6c9; }
        .board-forest .dark { background-color: #388e3c; }
        
        /* Styles de pièces Unicode */
        .pieces-classic .square[data-piece-color="white"] {
            color: #ffffff;
            text-shadow: 
                2px 2px 4px rgba(0,0,0,0.8),
                -1.5px -1.5px 0 #000,
                 1.5px -1.5px 0 #000,
                -1.5px  1.5px 0 #000,
                 1.5px  1.5px 0 #000;
        }

        .pieces-classic .square[data-piece-color="black"] {
            color: #1a1a1a;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.3);
        }

        .pieces-bold .square[data-piece-color="white"] {
            color: #f8f8f8;
            text-shadow: 
                3px 3px 6px rgba(0,0,0,0.9),
                -2px -2px 0 #000,
                 2px -2px 0 #000,
                -2px  2px 0 #000,
                 2px  2px 0 #000;
            font-weight: 900;
        }

        .pieces-bold .square[data-piece-color="black"] {
            color: #0a0a0a;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.4);
            font-weight: 900;
        }

        .pieces-elegant .square[data-piece-color="white"] {
            color: #ffffff;
            text-shadow: 
                1px 1px 3px rgba(0,0,0,0.7),
                -1px -1px 0 #333,
                 1px -1px 0 #333,
                -1px  1px 0 #333,
                 1px  1px 0 #333;
        }

        .pieces-elegant .square[data-piece-color="black"] {
            color: #2c2c2c;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.2);
        }

        .pieces-modern .square[data-piece-color="white"] {
            color: #e8e8e8;
            text-shadow: 
                2px 2px 4px rgba(0,0,0,0.6),
                -1px -1px 0 #666,
                 1px -1px 0 #666,
                -1px  1px 0 #666,
                 1px  1px 0 #666;
        }

        .pieces-modern .square[data-piece-color="black"] {
            color: #404040;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.15);
        }

        .pieces-contrast .square[data-piece-color="white"] {
            color: #ffffff;
            text-shadow: 
                4px 4px 8px rgba(0,0,0,1),
                -2.5px -2.5px 0 #000,
                 2.5px -2.5px 0 #000,
                -2.5px  2.5px 0 #000,
                 2.5px  2.5px 0 #000;
            font-weight: bold;
        }

        .pieces-contrast .square[data-piece-color="black"] {
            color: #000000;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.6);
            font-weight: bold;
        }
        
        .square.selected { background-color: #ffff99 !important; box-shadow: inset 0 0 0 3px #ff6b6b; }
        .square.last-move { background-color: #ffeb3b !important; }
        .square:hover { opacity: 0.8; }
        
        .theme-selector {
            margin-bottom: 15px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
        }
        .theme-selector h4 {
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        .theme-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        /* Zone des pièces capturées */
        .captured-pieces {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }

        .captured-pieces h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
        }

        .captured-row {
            display: flex;
            align-items: center;
            margin: 8px 0;
            min-height: 30px;
        }

        .captured-label {
            font-weight: bold;
            width: 80px;
            font-size: 14px;
        }

        .captured-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .captured-piece {
            font-size: 28px;
            padding: 2px 4px;
            border-radius: 4px;
            background: rgba(255,255,255,0.5);
        }

        /* Appliquer le même style aux pièces capturées */
        .pieces-classic .captured-piece.white {
            color: #ffffff;
            text-shadow: 
                1.5px 1.5px 3px rgba(0,0,0,0.8),
                -1px -1px 0 #000,
                 1px -1px 0 #000,
                -1px  1px 0 #000,
                 1px  1px 0 #000;
        }

        .pieces-classic .captured-piece.black {
            color: #1a1a1a;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.3);
        }

        .pieces-bold .captured-piece.white {
            color: #f8f8f8;
            text-shadow: 
                2px 2px 4px rgba(0,0,0,0.9),
                -1.5px -1.5px 0 #000,
                 1.5px -1.5px 0 #000,
                -1.5px  1.5px 0 #000,
                 1.5px  1.5px 0 #000;
            font-weight: 900;
        }

        .pieces-bold .captured-piece.black {
            color: #0a0a0a;
            text-shadow: 1.5px 1.5px 3px rgba(255,255,255,0.4);
            font-weight: 900;
        }
        
        .game-status { text-align: center; margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3; }
        .game-status h2 { color: #1976d2; margin-bottom: 5px; }
        .player-info { display: flex; justify-content: space-between; margin-bottom: 20px; gap: 10px; }
        .player { flex: 1; padding: 10px; border-radius: 8px; text-align: center; }
        .player.white { background: #fff; border: 2px solid #ddd; }
        .player.black { background: #333; color: white; border: 2px solid #555; }
        .player.active { border-color: #4caf50; box-shadow: 0 0 10px rgba(76, 175, 80, 0.3); }
        .move-history { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: white; }
        .move-history h3 { margin-bottom: 10px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .move-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f0f0f0; }
        .move-item:last-child { border-bottom: none; }
        .move-number { font-weight: bold; color: #666; }
        .move-notation { font-family: monospace; background: #f8f9fa; padding: 2px 6px; border-radius: 3px; }
        .controls { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.2s ease; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        .join-form { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; max-width: 500px; }
        .join-form h1 { margin-bottom: 20px; color: #333; }
        .game-mode-selection { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 15px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .mode-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .mode-btn:hover:not(.active) { border-color: #007bff; }
        .ai-difficulty { margin: 15px 0; text-align: left; }
        .ai-difficulty label { display: block; margin-bottom: 10px; font-weight: bold; color: #333; }
        .difficulty-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .btn-difficulty { padding: 8px 12px; border: 2px solid #ddd; background: white; border-radius: 5px; cursor: pointer; font-size: 12px; transition: all 0.2s ease; }
        .btn-difficulty.active { background: #28a745; color: white; border-color: #28a745; }
        .btn-difficulty:hover:not(.active) { border-color: #28a745; }
        #difficultyInfo { color: #666; font-style: italic; }
        .join-form input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .join-form input:focus { outline: none; border-color: #007bff; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="joinForm" class="join-form">
        <h1>🏁 Échecs Multijoueur</h1>
        <div class="game-mode-selection">
            <button class="btn btn-primary mode-btn active" onclick="selectGameMode('multiplayer')">👥 Contre un ami</button>
            <button class="btn btn-secondary mode-btn" onclick="selectGameMode('ai')">🤖 Contre l'IA</button>
        </div>
        <div id="multiplayerConfig">
            <input type="text" id="playerName" placeholder="Votre nom" maxlength="20">
            <input type="text" id="gameId" placeholder="ID de la partie (ou laissez vide)" maxlength="10">
        </div>
        <div id="aiConfig" class="hidden">
            <input type="text" id="playerNameAI" placeholder="Votre nom" maxlength="20">
            <div class="ai-difficulty">
                <label>Niveau de l'IA :</label>
                <div class="difficulty-buttons">
                    <button class="btn-difficulty" data-level="1">1️⃣ Débutant</button>
                    <button class="btn-difficulty" data-level="2">2️⃣ Facile</button>
                    <button class="btn-difficulty active" data-level="3">3️⃣ Moyen</button>
                    <button class="btn-difficulty" data-level="4">4️⃣ Difficile</button>
                    <button class="btn-difficulty" data-level="5">5️⃣ Expert</button>
                </div>
                <small id="difficultyInfo">Temps de réflexion: ~0.5s</small>
            </div>
        </div>
        <button class="btn btn-primary" onclick="startGame()">Commencer la partie</button>
        <br><small style="margin-top: 10px; display: block;"><a href="#" onclick="clearSavedData()" style="color: #666; text-decoration: none;">🗑️ Effacer les données sauvegardées</a></small>
    </div>

    <div id="gameInterface" class="game-container hidden">
        <div class="chess-board-container">
            <div class="game-status" id="gameStatus">
                <h2>En attente d'un adversaire...</h2>
                <p>Partagez l'ID de partie : <strong id="currentGameId"></strong></p>
            </div>
            <div class="player-info">
                <div class="player white" id="whitePlayer"><strong>Blancs</strong><div id="whitePlayerName">En attente...</div></div>
                <div class="player black" id="blackPlayer"><strong>Noirs</strong><div id="blackPlayerName">En attente...</div></div>
            </div>
            
            <!-- Conteneur centré avec coordonnées -->
            <div class="chess-container">
                <div class="chess-board-with-coords">
                    <div class="chess-board board-classic pieces-classic" id="chessBoard"></div>
                    
                    <!-- Coordonnées des files (en bas) -->
                    <div class="file-coords" id="fileCoords">
                        <div class="file-label">a</div>
                        <div class="file-label">b</div>
                        <div class="file-label">c</div>
                        <div class="file-label">d</div>
                        <div class="file-label">e</div>
                        <div class="file-label">f</div>
                        <div class="file-label">g</div>
                        <div class="file-label">h</div>
                    </div>
                    
                    <!-- Coordonnées des rangs (à droite) -->
                    <div class="rank-coords" id="rankCoords">
                        <div class="rank-label">8</div>
                        <div class="rank-label">7</div>
                        <div class="rank-label">6</div>
                        <div class="rank-label">5</div>
                        <div class="rank-label">4</div>
                        <div class="rank-label">3</div>
                        <div class="rank-label">2</div>
                        <div class="rank-label">1</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="game-info">
            <div class="theme-selector">
                <h4>🎨 Thème de l'échiquier</h4>
                <select id="boardTheme" onchange="changeBoardTheme()">
                    <option value="classic">Classique (Marron)</option>
                    <option value="green">Vert</option>
                    <option value="blue">Bleu</option>
                    <option value="wood">Bois</option>
                    <option value="marble">Marbre</option>
                    <option value="pink">Rose</option>
                    <option value="purple">Violet</option>
                    <option value="metal">Métal</option>
                    <option value="ocean">Océan</option>
                    <option value="forest">Forêt</option>
                </select>
            </div>
            
            <div class="theme-selector">
                <h4>♟️ Style des pièces</h4>
                <select id="pieceStyle" onchange="changePieceStyle()">
                    <option value="classic">Classique</option>
                    <option value="bold">Gras</option>
                    <option value="elegant">Élégant</option>
                    <option value="modern">Moderne</option>
                    <option value="contrast">Contraste Fort</option>
                </select>
            </div>
            
            <div class="captured-pieces">
                <h4>🏴 Pièces capturées</h4>
                <div class="captured-row">
                    <span class="captured-label">Blanches :</span>
                    <div class="captured-list" id="whiteCaptured"></div>
                </div>
                <div class="captured-row">
                    <span class="captured-label">Noires :</span>
                    <div class="captured-list" id="blackCaptured"></div>
                </div>
            </div>
            
            <div class="move-history"><h3>📜 Historique des coups</h3><div id="moveHistoryList"></div></div>
            <div class="controls">
                <button class="btn btn-primary" onclick="newGame()">Nouvelle partie</button>
                <button class="btn btn-secondary" onclick="copyGameLink()">Copier lien</button>
                <button class="btn btn-secondary" onclick="leaveGame()">Quitter</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket, gameId, playerColor, selectedSquare = null, currentGameState = null, moveHistory = [], isReconnecting = false, gameMode = 'multiplayer', aiDifficulty = 3;
        const pieces = { 'K': '♔', 'Q': '♕', 'R': '♖', 'B': '♗', 'N': '♘', 'P': '♙', 'k': '♚', 'q': '♛', 'r': '♜', 'b': '♝', 'n': '♞', 'p': '♟' };

        function changeBoardTheme() {
            const board = document.getElementById('chessBoard');
            const theme = document.getElementById('boardTheme').value;
            
            board.className = board.className.replace(/board-\w+/g, '');
            
            const existingClasses = board.className.split(' ').filter(cls => 
                cls === 'chess-board' || cls.startsWith('pieces-')
            ).join(' ');
            
            board.className = `${existingClasses} board-${theme}`;
            localStorage.setItem('chess_boardTheme', theme);
        }

        function changePieceStyle() {
            const board = document.getElementById('chessBoard');
            const style = document.getElementById('pieceStyle').value;
            
            board.className = board.className.replace(/pieces-\w+/g, '');
            
            const existingClasses = board.className.split(' ').filter(cls => 
                cls === 'chess-board' || cls.startsWith('board-')
            ).join(' ');
            
            board.className = `${existingClasses} pieces-${style}`;
            
            const capturedDiv = document.querySelector('.captured-pieces');
            if (capturedDiv) {
                capturedDiv.className = capturedDiv.className.replace(/pieces-\w+/g, '');
                capturedDiv.className += ` pieces-${style}`;
            }
            
            localStorage.setItem('chess_pieceStyle', style);
        }

        function updateCoordinates() {
            const isBlackPlayer = playerColor === 'black';
            
            const rankCoords = document.getElementById('rankCoords');
            const fileCoords = document.getElementById('fileCoords');
            
            if (isBlackPlayer) {
                rankCoords.innerHTML = `
                    <div class="rank-label">1</div>
                    <div class="rank-label">2</div>
                    <div class="rank-label">3</div>
                    <div class="rank-label">4</div>
                    <div class="rank-label">5</div>
                    <div class="rank-label">6</div>
                    <div class="rank-label">7</div>
                    <div class="rank-label">8</div>
                `;
                
                fileCoords.innerHTML = `
                    <div class="file-label">h</div>
                    <div class="file-label">g</div>
                    <div class="file-label">f</div>
                    <div class="file-label">e</div>
                    <div class="file-label">d</div>
                    <div class="file-label">c</div>
                    <div class="file-label">b</div>
                    <div class="file-label">a</div>
                `;
                
                console.log('🔄 Coordonnées pour joueur noir');
            } else {
                rankCoords.innerHTML = `
                    <div class="rank-label">8</div>
                    <div class="rank-label">7</div>
                    <div class="rank-label">6</div>
                    <div class="rank-label">5</div>
                    <div class="rank-label">4</div>
                    <div class="rank-label">3</div>
                    <div class="rank-label">2</div>
                    <div class="rank-label">1</div>
                `;
                
                fileCoords.innerHTML = `
                    <div class="file-label">a</div>
                    <div class="file-label">b</div>
                    <div class="file-label">c</div>
                    <div class="file-label">d</div>
                    <div class="file-label">e</div>
                    <div class="file-label">f</div>
                    <div class="file-label">g</div>
                    <div class="file-label">h</div>
                `;
                
                console.log('🔄 Coordonnées pour joueur blanc');
            }
        }
        
        function loadThemePreferences() {
            const savedBoardTheme = localStorage.getItem('chess_boardTheme');
            const savedPieceStyle = localStorage.getItem('chess_pieceStyle');
            
            if (savedBoardTheme) {
                document.getElementById('boardTheme').value = savedBoardTheme;
                changeBoardTheme();
            }
            
            if (savedPieceStyle) {
                document.getElementById('pieceStyle').value = savedPieceStyle;
                changePieceStyle();
            } else {
                const board = document.getElementById('chessBoard');
                if (!board.className.includes('pieces-')) {
                    board.className += ' pieces-classic';
                }
                const capturedDiv = document.querySelector('.captured-pieces');
                if (capturedDiv && !capturedDiv.className.includes('pieces-')) {
                    capturedDiv.className += ' pieces-classic';
                }
            }
        }

        function selectGameMode(mode) { 
            gameMode = mode; 
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active')); 
            event.target.classList.add('active'); 
            
            if (mode === 'multiplayer') { 
                document.getElementById('multiplayerConfig').classList.remove('hidden'); 
                document.getElementById('aiConfig').classList.add('hidden'); 
            } else { 
                document.getElementById('multiplayerConfig').classList.add('hidden'); 
                document.getElementById('aiConfig').classList.remove('hidden'); 
            } 
        }

        function startGame() { 
            if (gameMode === 'multiplayer') { 
                joinGame(); 
            } else { 
                startAIGame(); 
            } 
        }

        function joinGame() { 
            const playerName = document.getElementById('playerName').value.trim(); 
            if (!playerName) { 
                alert('Veuillez entrer votre nom'); 
                return; 
            } 
            
            gameId = document.getElementById('gameId').value.trim() || generateGameId(); 
            document.getElementById('currentGameId').textContent = gameId; 
            localStorage.setItem('chess_gameId', gameId); 
            localStorage.setItem('chess_playerName', playerName); 
            localStorage.setItem('chess_gameMode', 'multiplayer'); 
            
            initSocket(); 
            socket.emit('join-game', { gameId, playerName, isReconnectionAttempt: isReconnecting }); 
            
            document.getElementById('joinForm').classList.add('hidden'); 
            document.getElementById('gameInterface').classList.remove('hidden'); 
            loadThemePreferences(); 
        }

        function startAIGame() { 
            const playerName = document.getElementById('playerNameAI').value.trim(); 
            if (!playerName) { 
                alert('Veuillez entrer votre nom'); 
                return; 
            } 
            
            gameId = 'ai_' + generateGameId(); 
            document.getElementById('currentGameId').textContent = gameId + ' (vs IA)'; 
            localStorage.setItem('chess_gameId', gameId); 
            localStorage.setItem('chess_playerName', playerName); 
            localStorage.setItem('chess_gameMode', 'ai'); 
            localStorage.setItem('chess_aiDifficulty', aiDifficulty); 
            
            initSocket(); 
            socket.emit('join-ai-game', { gameId, playerName, aiDifficulty }); 
            
            document.getElementById('joinForm').classList.add('hidden'); 
            document.getElementById('gameInterface').classList.remove('hidden'); 
            loadThemePreferences(); 
        }

        function generateGameId() { 
            return Math.random().toString(36).substr(2, 6).toUpperCase(); 
        }

        function clearSavedData() { 
            localStorage.removeItem('chess_gameId'); 
            localStorage.removeItem('chess_playerName'); 
            localStorage.removeItem('chess_gameMode'); 
            localStorage.removeItem('chess_aiDifficulty'); 
            localStorage.removeItem('chess_boardTheme'); 
            localStorage.removeItem('chess_pieceStyle'); 
            alert('✅ Données sauvegardées effacées'); 
            location.reload(); 
        }

        function initSocket() {
            socket = io();
            setInterval(() => { if (socket.connected) { socket.emit('ping'); } }, 25000);
            socket.on('pong', () => console.log('🏓 Connexion active'));
            socket.on('connect', () => console.log('🔌 Connecté au serveur'));
            socket.on('disconnect', (reason) => { console.log('❌ Déconnecté:', reason); updateGameStatus('⚠️ Connexion perdue... Reconnexion...'); });
            socket.on('reconnect', () => { console.log('🔄 Reconnecté au serveur'); if (gameId && localStorage.getItem('chess_playerName')) { socket.emit('join-game', { gameId, playerName: localStorage.getItem('chess_playerName') }); } });
            socket.on('player-assigned', (data) => { playerColor = data.color; currentGameState = data.gameState; createBoard(); updateBoard(); updateGameStatus(`Vous jouez les ${playerColor === 'white' ? 'Blancs' : 'Noirs'}`); });
            socket.on('game-start', (data) => { document.getElementById('whitePlayerName').textContent = data.white; document.getElementById('blackPlayerName').textContent = data.black; currentGameState = data.gameState; if (!document.getElementById('chessBoard').hasChildNodes()) { createBoard(); } updateBoard(); updateGameStatus('La partie commence !'); updatePlayerTurn(); });
            socket.on('ai-game-start', (data) => { document.getElementById('whitePlayerName').textContent = data.player; document.getElementById('blackPlayerName').textContent = `🤖 IA Niveau ${data.aiLevel}`; currentGameState = data.gameState; if (!document.getElementById('chessBoard').hasChildNodes()) { createBoard(); } updateBoard(); updateGameStatus('Partie contre IA commencée ! Vous jouez les Blancs'); updatePlayerTurn(); });
            socket.on('move-made', (data) => { const moveText = data.isAIMove ? `🤖 IA joue: ${data.move.san}` : `📨 Coup reçu: ${data.move.san}`; console.log(moveText); currentGameState = data.gameState; moveHistory = data.moveHistory; updateBoard(); updateMoveHistory(); updatePlayerTurn(); clearSelection(); if (data.isAIMove) { updateGameStatus('🤖 IA a joué - À votre tour !'); } });
            socket.on('move-history', (data) => { moveHistory = data; updateMoveHistory(); });
            socket.on('game-over', (data) => { updateGameStatus(`🏁 ${data.result}`); clearSelection(); });
            socket.on('invalid-move', (message) => { console.log('❌ Coup invalide:', message); updateBoard(); clearSelection(); alert(message); });
            socket.on('player-reconnected', (data) => { console.log(`🔄 ${data.playerName} s'est reconnecté`); updateGameStatus(`✅ ${data.playerName} s'est reconnecté !`); setTimeout(() => { updatePlayerTurn(); }, 1000); });
            socket.on('player-temporarily-disconnected', (data) => { console.log(`⚠️ ${data.playerName} temporairement déconnecté`); updateGameStatus(`⚠️ ${data.message}`); });
            socket.on('player-disconnected', () => { updateGameStatus('❌ Un joueur s\'est définitivement déconnecté'); });
            socket.on('spectator-mode', (data) => { currentGameState = data.gameState; moveHistory = data.moveHistory; updateBoard(); updateMoveHistory(); updateGameStatus('👀 Mode spectateur'); if (data.players.white) { document.getElementById('whitePlayerName').textContent = data.players.white; } if (data.players.black) { document.getElementById('blackPlayerName').textContent = data.players.black; } });
            socket.on('game-reset', (data) => { currentGameState = data.gameState; moveHistory = data.moveHistory; updateBoard(); updateMoveHistory(); updateGameStatus('Nouvelle partie commencée !'); clearSelection(); });
        }

        function createBoard() { 
            const board = document.getElementById('chessBoard'); 
            board.innerHTML = ''; 
            
            if (!board.className.includes('pieces-')) {
                board.className += ' pieces-classic';
            }
            if (!board.className.includes('board-')) {
                board.className += ' board-classic';
            }
            
            console.log(`🎯 Création échiquier pour: ${playerColor}`);
            
            if (playerColor === 'black') {
                for (let rank = 1; rank <= 8; rank++) {
                    for (let file = 7; file >= 0; file--) {
                        const square = document.createElement('div');
                        const squareId = String.fromCharCode(97 + file) + rank;
                        square.id = squareId;
                        square.className = `square ${(rank + file) % 2 === 0 ? 'light' : 'dark'}`;
                        square.addEventListener('click', () => handleSquareClick(squareId));
                        board.appendChild(square);
                    }
                }
            } else {
                for (let rank = 8; rank >= 1; rank--) {
                    for (let file = 0; file < 8; file++) {
                        const square = document.createElement('div');
                        const squareId = String.fromCharCode(97 + file) + rank;
                        square.id = squareId;
                        square.className = `square ${(rank + file) % 2 === 0 ? 'light' : 'dark'}`;
                        square.addEventListener('click', () => handleSquareClick(squareId));
                        board.appendChild(square);
                    }
                }
            }
            
            updateCoordinates();
            updateBoard();
        }

        function updateBoard() { 
    if (!currentGameState) { 
        console.log('⚠️ Pas d\'état de jeu disponible'); 
        return; 
    } 
    const board = fenToBoard(currentGameState); 
    
    for (let rank = 1; rank <= 8; rank++) { 
        for (let file = 0; file < 8; file++) { 
            const squareId = String.fromCharCode(97 + file) + rank; 
            const square = document.getElementById(squareId); 
            if (!square) continue; 
            
            const piece = board[8 - rank][file]; 
            
            if (piece && pieces[piece]) {
                square.textContent = pieces[piece];
                square.setAttribute('data-piece-color', piece === piece.toUpperCase() ? 'white' : 'black');
            } else {
                square.textContent = '';
                square.removeAttribute('data-piece-color');
            }
            
            square.className = `square ${(rank + file) % 2 === 0 ? 'light' : 'dark'}`; 
            
            if (moveHistory.length > 0) { 
                const lastMove = moveHistory[moveHistory.length - 1]; 
                if (squareId === lastMove.from || squareId === lastMove.to) { 
                    square.classList.add('last-move'); 
                }
                
                // NOUVEAU: Indiquer les coups spéciaux
                if (lastMove.flags) {
                    if (lastMove.flags.includes('e')) { // En passant
                        square.title = 'Prise en passant';
                    }
                    if (lastMove.flags.includes('k') || lastMove.flags.includes('q')) { // Roque
                        square.title = 'Roque';
                    }
                    if (lastMove.flags.includes('p')) { // Promotion
                        square.title = 'Promotion';
                    }
                }
            } 
        } 
    }
    
    updateCapturedPieces();
}

        function updateCapturedPieces() {
            const captured = getCapturedPieces();
            
            const whiteCapturedDiv = document.getElementById('whiteCaptured');
            const blackCapturedDiv = document.getElementById('blackCaptured');
            
            if (whiteCapturedDiv) {
                whiteCapturedDiv.innerHTML = captured.white.map(piece => 
                    `<span class="captured-piece white">${pieces[piece]}</span>`
                ).join('');
            }
            
            if (blackCapturedDiv) {
                blackCapturedDiv.innerHTML = captured.black.map(piece => 
                    `<span class="captured-piece black">${pieces[piece]}</span>`
                ).join('');
            }
        }

        function getCapturedPieces() {
            const startingPieces = {
                'K': 1, 'Q': 1, 'R': 2, 'B': 2, 'N': 2, 'P': 8,
                'k': 1, 'q': 1, 'r': 2, 'b': 2, 'n': 2, 'p': 8
            };
            
            const currentPieces = {};
            Object.keys(startingPieces).forEach(piece => currentPieces[piece] = 0);
            
            if (currentGameState) {
                const board = fenToBoard(currentGameState);
                for (let rank = 0; rank < 8; rank++) {
                    for (let file = 0; file < 8; file++) {
                        const piece = board[rank][file];
                        if (piece && currentPieces.hasOwnProperty(piece)) {
                            currentPieces[piece]++;
                        }
                    }
                }
            }
            
            const captured = { white: [], black: [] };
            
            Object.keys(startingPieces).forEach(piece => {
                const missing = startingPieces[piece] - currentPieces[piece];
                const isWhitePiece = piece === piece.toUpperCase();
                
                for (let i = 0; i < missing; i++) {
                    if (isWhitePiece) {
                        captured.white.push(piece);
                    } else {
                        captured.black.push(piece);
                    }
                }
            });
            
            return captured;
        }

        function fenToBoard(fen) { 
            const position = fen.split(' ')[0]; 
            const ranks = position.split('/'); 
            const board = []; 
            for (const rank of ranks) { 
                const row = []; 
                for (const char of rank) { 
                    if (isNaN(char)) { 
                        row.push(char); 
                    } else { 
                        for (let i = 0; i < parseInt(char); i++) { 
                            row.push(null); 
                        } 
                    } 
                } 
                board.push(row); 
            } 
            return board; 
        }

        function handleSquareClick(squareId) { 
            if (!selectedSquare) { 
                const square = document.getElementById(squareId); 
                if (square.textContent) { 
                    selectedSquare = squareId; 
                    square.classList.add('selected'); 
                } 
            } else { 
                if (selectedSquare !== squareId) { 
                    makeMove(selectedSquare, squareId); 
                } 
                clearSelection(); 
            } 
        }

        function clearSelection() { 
            if (selectedSquare) { 
                const square = document.getElementById(selectedSquare); 
                square.classList.remove('selected'); 
                selectedSquare = null; 
            } 
            document.querySelectorAll('.square.highlight').forEach(sq => { 
                sq.classList.remove('highlight'); 
            }); 
        }

function makeMove(from, to) { 
    console.log('🎯 Tentative de coup:', from, 'vers', to); 
    
    // Créer un objet move plus complet pour chess.js
    const moveData = { from, to };
    
    // Vérifier si c'est une promotion (pion atteignant la dernière rangée)
    const fromSquare = document.getElementById(from);
    if (fromSquare && fromSquare.textContent) {
        const piece = fromSquare.textContent;
        const isPawn = piece === '♙' || piece === '♟';
        const toRank = parseInt(to[1]);
        
        if (isPawn && (toRank === 8 || toRank === 1)) {
            // Demander le choix de promotion
            const promotionChoice = prompt(
                "Promotion du pion ! Choisissez une pièce :\n" +
                "q = Dame\n" +
                "r = Tour\n" +
                "b = Fou\n" +
                "n = Cavalier",
                "q"
            );
            
            if (promotionChoice && ['q', 'r', 'b', 'n'].includes(promotionChoice.toLowerCase())) {
                moveData.promotion = promotionChoice.toLowerCase();
            } else {
                moveData.promotion = 'q'; // Dame par défaut
            }
        }
    }
    
    updateBoardOptimistic(from, to); 
    socket.emit('make-move', { gameId: gameId, move: moveData }); 
}

        function updateBoardOptimistic(from, to) { 
            const fromSquare = document.getElementById(from); 
            const toSquare = document.getElementById(to); 
            if (fromSquare && toSquare) { 
                const pieceColor = fromSquare.getAttribute('data-piece-color');
                
                toSquare.textContent = fromSquare.textContent; 
                if (pieceColor) {
                    toSquare.setAttribute('data-piece-color', pieceColor);
                }
                
                fromSquare.textContent = ''; 
                fromSquare.removeAttribute('data-piece-color');
                
                document.querySelectorAll('.last-move').forEach(sq => sq.classList.remove('last-move')); 
                fromSquare.classList.add('last-move'); 
                toSquare.classList.add('last-move'); 
            } 
        }

        function updateMoveHistory() { 
            const historyList = document.getElementById('moveHistoryList'); 
            historyList.innerHTML = ''; 
            for (let i = 0; i < moveHistory.length; i++) { 
                const move = moveHistory[i]; 
                const moveItem = document.createElement('div'); 
                moveItem.className = 'move-item'; 
                const moveNumber = Math.floor(i / 2) + 1; 
                const isWhiteMove = i % 2 === 0; 
                moveItem.innerHTML = `<span class="move-number">${moveNumber}${isWhiteMove ? '.' : '...'}</span><span class="move-notation">${move.move}</span>`; 
                historyList.appendChild(moveItem); 
            } 
            historyList.scrollTop = historyList.scrollHeight; 
        }

        function updateGameStatus(message) { 
            document.getElementById('gameStatus').innerHTML = `<h2>${message}</h2>`; 
        }

        function updatePlayerTurn() { 
            const fen = currentGameState; 
            const turn = fen.split(' ')[1]; 
            const whitePlayer = document.getElementById('whitePlayer'); 
            const blackPlayer = document.getElementById('blackPlayer'); 
            whitePlayer.classList.remove('active'); 
            blackPlayer.classList.remove('active'); 
            if (turn === 'w') { 
                whitePlayer.classList.add('active'); 
                updateGameStatus('Au tour des Blancs'); 
            } else { 
                blackPlayer.classList.add('active'); 
                updateGameStatus('Au tour des Noirs'); 
            } 
        }

        function newGame() { 
            if (confirm('Êtes-vous sûr de vouloir commencer une nouvelle partie ?')) { 
                socket.emit('new-game', gameId); 
            } 
        }

        function copyGameLink() { 
            const link = `${window.location.origin}/game/${gameId}`; 
            navigator.clipboard.writeText(link).then(() => { 
                alert('Lien copié dans le presse-papiers !'); 
            }); 
        }

        function leaveGame() { 
            if (confirm('Êtes-vous sûr de vouloir quitter la partie ?')) { 
                location.reload(); 
            } 
        }
        
        document.addEventListener('DOMContentLoaded', () => { 
            document.querySelectorAll('.btn-difficulty').forEach(btn => { 
                btn.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    document.querySelectorAll('.btn-difficulty').forEach(b => b.classList.remove('active')); 
                    btn.classList.add('active'); 
                    aiDifficulty = parseInt(btn.dataset.level); 
                    const difficultyInfo = { 
                        1: "Temps de réflexion: ~0.1s (Très facile)", 
                        2: "Temps de réflexion: ~0.2s (Facile)", 
                        3: "Temps de réflexion: ~0.5s (Moyen)", 
                        4: "Temps de réflexion: ~2s (Difficile)", 
                        5: "Temps de réflexion: ~5s (Expert)" 
                    }; 
                    document.getElementById('difficultyInfo').textContent = difficultyInfo[aiDifficulty]; 
                }); 
            }); 
        });

        window.addEventListener('load', () => { 
            const urlPath = window.location.pathname; 
            const match = urlPath.match(/\/game\/(.+)/); 
            if (match) { 
                document.getElementById('gameId').value = match[1]; 
            } 
            const savedGameId = localStorage.getItem('chess_gameId'); 
            const savedPlayerName = localStorage.getItem('chess_playerName'); 
            const savedGameMode = localStorage.getItem('chess_gameMode'); 
            if (savedGameId && savedPlayerName) { 
                if (savedGameMode === 'ai') { 
                    document.getElementById('playerNameAI').value = savedPlayerName; 
                    localStorage.removeItem('chess_gameId'); 
                    localStorage.removeItem('chess_playerName'); 
                    localStorage.removeItem('chess_gameMode'); 
                    return; 
                } else { 
                    document.getElementById('gameId').value = savedGameId; 
                    document.getElementById('playerName').value = savedPlayerName; 
                } 
                const reconnectMessage = `Voulez-vous vous reconnecter à la partie ${savedGameId} en tant que ${savedPlayerName} ?`; 
                if (confirm(reconnectMessage)) { 
                    isReconnecting = true; 
                    selectGameMode('multiplayer'); 
                    joinGame(); 
                } else { 
                    localStorage.removeItem('chess_gameId'); 
                    localStorage.removeItem('chess_playerName'); 
                    localStorage.removeItem('chess_gameMode'); 
                } 
            } 
        });
    </script>
</body>
</html>