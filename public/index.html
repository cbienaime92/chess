<!-- index.html  -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âchecs Multijoueur</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .game-container { display: flex; gap: 20px; max-width: 1200px; width: 100%; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .chess-board-container { padding: 20px; flex: 1; }
        .game-info { background: #f8f9fa; padding: 20px; width: 300px; border-left: 1px solid #dee2e6; }
.chess-board { 
    width: 500px; 
    height: 500px; 
    margin: 0 auto; 
    border: 3px solid #8b4513; 
    border-radius: 8px; 
    display: grid; 
    grid-template-columns: repeat(8, 1fr); 
    grid-template-rows: repeat(8, 1fr); 
}
.square { 
    width: 62.5px; 
    height: 62.5px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 45px; 
    cursor: pointer; 
    position: relative; 
    transition: all 0.2s ease; 
}        
.piece-svg {
    width: 38px;
    height: 38px;
    pointer-events: none;
}

/* Th√®mes des pi√®ces */
.pieces-classic .piece-white { 
    fill: #ffffff; 
    stroke: #000000; 
    stroke-width: 0.5; 
}
.pieces-classic .piece-black { 
    fill: #000000; 
    stroke: #333333; 
    stroke-width: 0.5; 
}

.pieces-modern .piece-white { 
    fill: #e8e8e8; 
    stroke: #666666; 
    stroke-width: 1; 
}
.pieces-modern .piece-black { 
    fill: #2c2c2c; 
    stroke: #000000; 
    stroke-width: 1; 
}

.pieces-gold .piece-white { 
    fill: #ffd700; 
    stroke: #b8860b; 
    stroke-width: 1; 
}
.pieces-gold .piece-black { 
    fill: #8b4513; 
    stroke: #654321; 
    stroke-width: 1; 
}

.pieces-crystal .piece-white { 
    fill: #e6f3ff; 
    stroke: #4169e1; 
    stroke-width: 1.5; 
}
.pieces-crystal .piece-black { 
    fill: #1e3a8a; 
    stroke: #000080; 
    stroke-width: 1.5; 
}

.pieces-neon .piece-white { 
    fill: #00ff00; 
    stroke: #008000; 
    stroke-width: 2; 
    filter: drop-shadow(0 0 3px #00ff00); 
}
.pieces-neon .piece-black { 
    fill: #ff0080; 
    stroke: #800040; 
    stroke-width: 2; 
    filter: drop-shadow(0 0 3px #ff0080); 
}

        /* Th√®mes d'√©chiquier */
        .board-classic .light { background-color: #f0d9b5; }
        .board-classic .dark { background-color: #b58863; }
        
        .board-green .light { background-color: #eeeed2; }
        .board-green .dark { background-color: #769656; }
        
        .board-blue .light { background-color: #dee3e6; }
        .board-blue .dark { background-color: #8ca2ad; }
        
        .board-wood .light { background-color: #f3e4c9; }
        .board-wood .dark { background-color: #c19a6b; }
        
        .board-marble .light { background-color: #efefef; }
        .board-marble .dark { background-color: #8a8a8a; }
        
        .board-pink .light { background-color: #ffe6f0; }
        .board-pink .dark { background-color: #ffb3d9; }
        
        .board-purple .light { background-color: #e6e0ff; }
        .board-purple .dark { background-color: #9999ff; }
        
        .board-metal .light { background-color: #e0e0e0; }
        .board-metal .dark { background-color: #606060; }
        
        .board-ocean .light { background-color: #b3e5fc; }
        .board-ocean .dark { background-color: #0288d1; }
        
        .board-forest .light { background-color: #c8e6c9; }
        .board-forest .dark { background-color: #388e3c; }
        
        /* Par d√©faut sans th√®me */
        .square.light { background-color: #f0d9b5; }
        .square.dark { background-color: #b58863; }

        .square[data-piece-color="white"] {
    color: #ffffff;
    text-shadow: 
        2px 2px 4px rgba(0,0,0,0.8),
        -1.5px -1.5px 0 #000,
         1.5px -1.5px 0 #000,
        -1.5px  1.5px 0 #000,
         1.5px  1.5px 0 #000;
}

.square[data-piece-color="black"] {
    color: #1a1a1a;
    text-shadow: 1px 1px 2px rgba(255,255,255,0.3);
}

/* Zone des pi√®ces captur√©es */
.captured-pieces {
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #2196f3;
}

.captured-pieces h4 {
    margin-bottom: 10px;
    color: #333;
    font-size: 14px;
}

.captured-row {
    display: flex;
    align-items: center;
    margin: 8px 0;
    min-height: 30px;
}

.captured-label {
    font-weight: bold;
    width: 80px;
    font-size: 14px;
}

.captured-list {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.captured-piece {
    font-size: 28px;
    padding: 2px 4px;
    border-radius: 4px;
    background: rgba(255,255,255,0.5);
}

.captured-piece.white {
    color: #ffffff;
    text-shadow: 
        1.5px 1.5px 3px rgba(0,0,0,0.8),
        -1px -1px 0 #000,
         1px -1px 0 #000,
        -1px  1px 0 #000,
         1px  1px 0 #000;
}

.captured-piece.black {
    color: #1a1a1a;
    text-shadow: 1px 1px 2px rgba(255,255,255,0.3);
}
        
        .square.selected { background-color: #ffff99 !important; box-shadow: inset 0 0 0 3px #ff6b6b; }
        .square.last-move { background-color: #ffeb3b !important; }
        .square:hover { opacity: 0.8; }
        
        .theme-selector {
            margin-bottom: 15px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
        }
        .theme-selector h4 {
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        .theme-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        .game-status { text-align: center; margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3; }
        .game-status h2 { color: #1976d2; margin-bottom: 5px; }
        .player-info { display: flex; justify-content: space-between; margin-bottom: 20px; gap: 10px; }
        .player { flex: 1; padding: 10px; border-radius: 8px; text-align: center; }
        .player.white { background: #fff; border: 2px solid #ddd; }
        .player.black { background: #333; color: white; border: 2px solid #555; }
        .player.active { border-color: #4caf50; box-shadow: 0 0 10px rgba(76, 175, 80, 0.3); }
        .move-history { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: white; }
        .move-history h3 { margin-bottom: 10px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .move-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f0f0f0; }
        .move-item:last-child { border-bottom: none; }
        .move-number { font-weight: bold; color: #666; }
        .move-notation { font-family: monospace; background: #f8f9fa; padding: 2px 6px; border-radius: 3px; }
        .controls { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.2s ease; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        .join-form { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; max-width: 500px; }
        .join-form h1 { margin-bottom: 20px; color: #333; }
        .game-mode-selection { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 15px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .mode-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .mode-btn:hover:not(.active) { border-color: #007bff; }
        .ai-difficulty { margin: 15px 0; text-align: left; }
        .ai-difficulty label { display: block; margin-bottom: 10px; font-weight: bold; color: #333; }
        .difficulty-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .btn-difficulty { padding: 8px 12px; border: 2px solid #ddd; background: white; border-radius: 5px; cursor: pointer; font-size: 12px; transition: all 0.2s ease; }
        .btn-difficulty.active { background: #28a745; color: white; border-color: #28a745; }
        .btn-difficulty:hover:not(.active) { border-color: #28a745; }
        #difficultyInfo { color: #666; font-style: italic; }
        .join-form input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .join-form input:focus { outline: none; border-color: #007bff; }
        .hidden { display: none; }
        @media (max-width: 768px) { .game-container { flex-direction: column; } .game-info { width: 100%; border-left: none; border-top: 1px solid #dee2e6; } .chess-board { width: 320px; height: 320px; } .square { width: 40px; height: 40px; font-size: 24px; } }
    </style>
</head>
<body>
    <div id="joinForm" class="join-form">
        <h1>üèÅ √âchecs Multijoueur</h1>
        <div class="game-mode-selection">
            <button class="btn btn-primary mode-btn active" onclick="selectGameMode('multiplayer')">üë• Contre un ami</button>
            <button class="btn btn-secondary mode-btn" onclick="selectGameMode('ai')">ü§ñ Contre l'IA</button>
        </div>
        <div id="multiplayerConfig">
            <input type="text" id="playerName" placeholder="Votre nom" maxlength="20">
            <input type="text" id="gameId" placeholder="ID de la partie (ou laissez vide)" maxlength="10">
        </div>
        <div id="aiConfig" class="hidden">
            <input type="text" id="playerNameAI" placeholder="Votre nom" maxlength="20">
            <div class="ai-difficulty">
                <label>Niveau de l'IA :</label>
                <div class="difficulty-buttons">
                    <button class="btn-difficulty" data-level="1">1Ô∏è‚É£ D√©butant</button>
                    <button class="btn-difficulty" data-level="2">2Ô∏è‚É£ Facile</button>
                    <button class="btn-difficulty active" data-level="3">3Ô∏è‚É£ Moyen</button>
                    <button class="btn-difficulty" data-level="4">4Ô∏è‚É£ Difficile</button>
                    <button class="btn-difficulty" data-level="5">5Ô∏è‚É£ Expert</button>
                </div>
                <small id="difficultyInfo">Temps de r√©flexion: ~0.5s</small>
            </div>
        </div>
        <button class="btn btn-primary" onclick="startGame()">Commencer la partie</button>
        <br><small style="margin-top: 10px; display: block;"><a href="#" onclick="clearSavedData()" style="color: #666; text-decoration: none;">üóëÔ∏è Effacer les donn√©es sauvegard√©es</a></small>
    </div>

    <div id="gameInterface" class="game-container hidden">
        <div class="chess-board-container">
            <div class="game-status" id="gameStatus">
                <h2>En attente d'un adversaire...</h2>
                <p>Partagez l'ID de partie : <strong id="currentGameId"></strong></p>
            </div>
            <div class="player-info">
                <div class="player white" id="whitePlayer"><strong>Blancs</strong><div id="whitePlayerName">En attente...</div></div>
                <div class="player black" id="blackPlayer"><strong>Noirs</strong><div id="blackPlayerName">En attente...</div></div>
            </div>
            <div class="chess-board board-classic" id="chessBoard"></div>
        </div>
        <div class="game-info">
            <div class="theme-selector">
    <h4>üé® Th√®me de l'√©chiquier</h4>
    <select id="boardTheme" onchange="changeBoardTheme()">
        <option value="classic">Classique (Marron)</option>
        <option value="green">Vert</option>
        <option value="blue">Bleu</option>
        <option value="wood">Bois</option>
        <option value="marble">Marbre</option>
        <option value="pink">Rose</option>
        <option value="purple">Violet</option>
        <option value="metal">M√©tal</option>
        <option value="ocean">Oc√©an</option>
        <option value="forest">For√™t</option>
    </select>
</div>
<div class="theme-selector">
    <h4>‚ôüÔ∏è Style des pi√®ces</h4>
    <select id="pieceTheme" onchange="changePieceTheme()">
        <option value="classic">Classique</option>
        <option value="modern">Moderne</option>
        <option value="gold">Dor√©</option>
        <option value="crystal">Cristal</option>
        <option value="neon">N√©on</option>
    </select>
</div>
<div class="captured-pieces">
    <h4>üè¥ Pi√®ces captur√©es</h4>
    <div class="captured-row">
        <span class="captured-label">Blanches :</span>
        <div class="captured-list" id="whiteCaptured"></div>
    </div>
    <div class="captured-row">
        <span class="captured-label">Noires :</span>
        <div class="captured-list" id="blackCaptured"></div>
    </div>
</div>
            <div class="move-history"><h3>üìú Historique des coups</h3><div id="moveHistoryList"></div></div>
            <div class="controls">
                <button class="btn btn-primary" onclick="newGame()">Nouvelle partie</button>
                <button class="btn btn-secondary" onclick="copyGameLink()">Copier lien</button>
                <button class="btn btn-secondary" onclick="leaveGame()">Quitter</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
       // Remplacer tout le JavaScript dans index.html par ce code corrig√© :

let socket, gameId, playerColor, selectedSquare = null, currentGameState = null, moveHistory = [], isReconnecting = false, gameMode = 'multiplayer', aiDifficulty = 3;
const pieces = { 
    'K': '‚ôî', 'Q': '‚ôï', 'R': '‚ôñ', 'B': '‚ôó', 'N': '‚ôò', 'P': '‚ôô', 
    'k': '‚ôö', 'q': '‚ôõ', 'r': '‚ôú', 'b': '‚ôù', 'n': '‚ôû', 'p': '‚ôü' 
};
function changeBoardTheme() {
    const board = document.getElementById('chessBoard');
    const theme = document.getElementById('boardTheme').value;
    
    // Retirer toutes les classes de th√®me d'√©chiquier
    board.className = board.className.replace(/board-\w+/g, '');
    
    // Ajouter la nouvelle classe de th√®me
    board.className = 'chess-board board-' + theme + ' ' + (board.className.match(/pieces-\w+/) || ['pieces-classic'])[0];
    
    localStorage.setItem('chess_boardTheme', theme);
}

function changePieceTheme() {
    const board = document.getElementById('chessBoard');
    const theme = document.getElementById('pieceTheme').value;
    
    // Retirer toutes les classes de th√®me de pi√®ces
    board.className = board.className.replace(/pieces-\w+/g, '');
    
    // Ajouter la nouvelle classe de th√®me
    board.className = board.className + ' pieces-' + theme;
    
    localStorage.setItem('chess_pieceTheme', theme);
}

function loadThemePreferences() {
    const savedBoardTheme = localStorage.getItem('chess_boardTheme');
    const savedPieceTheme = localStorage.getItem('chess_pieceTheme');
    
    if (savedBoardTheme) {
        document.getElementById('boardTheme').value = savedBoardTheme;
        changeBoardTheme();
    }
    
    if (savedPieceTheme) {
        document.getElementById('pieceTheme').value = savedPieceTheme;
        changePieceTheme();
    } else {
        // Appliquer le th√®me par d√©faut
        const board = document.getElementById('chessBoard');
        board.className += ' pieces-classic';
    }
}

function selectGameMode(mode) { 
    gameMode = mode; 
    
    // Enlever la classe active de tous les boutons
    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active')); 
    
    // Ajouter la classe active au bouton cliqu√©
    event.target.classList.add('active'); 
    
    if (mode === 'multiplayer') { 
        document.getElementById('multiplayerConfig').classList.remove('hidden'); 
        document.getElementById('aiConfig').classList.add('hidden'); 
    } else { 
        document.getElementById('multiplayerConfig').classList.add('hidden'); 
        document.getElementById('aiConfig').classList.remove('hidden'); 
    } 
}

function startGame() { 
    if (gameMode === 'multiplayer') { 
        joinGame(); 
    } else { 
        startAIGame(); 
    } 
}

function joinGame() { 
    const playerName = document.getElementById('playerName').value.trim(); 
    if (!playerName) { 
        alert('Veuillez entrer votre nom'); 
        return; 
    } 
    
    gameId = document.getElementById('gameId').value.trim() || generateGameId(); 
    document.getElementById('currentGameId').textContent = gameId; 
    localStorage.setItem('chess_gameId', gameId); 
    localStorage.setItem('chess_playerName', playerName); 
    localStorage.setItem('chess_gameMode', 'multiplayer'); 
    
    initSocket(); 
    socket.emit('join-game', { gameId, playerName, isReconnectionAttempt: isReconnecting }); 
    
    document.getElementById('joinForm').classList.add('hidden'); 
    document.getElementById('gameInterface').classList.remove('hidden'); 
    loadThemePreferences(); 
}

function startAIGame() { 
    const playerName = document.getElementById('playerNameAI').value.trim(); 
    if (!playerName) { 
        alert('Veuillez entrer votre nom'); 
        return; 
    } 
    
    gameId = 'ai_' + generateGameId(); 
    document.getElementById('currentGameId').textContent = gameId + ' (vs IA)'; 
    localStorage.setItem('chess_gameId', gameId); 
    localStorage.setItem('chess_playerName', playerName); 
    localStorage.setItem('chess_gameMode', 'ai'); 
    localStorage.setItem('chess_aiDifficulty', aiDifficulty); 
    
    initSocket(); 
    socket.emit('join-ai-game', { gameId, playerName, aiDifficulty }); 
    
    document.getElementById('joinForm').classList.add('hidden'); 
    document.getElementById('gameInterface').classList.remove('hidden'); 
    loadThemePreferences(); 
}

function generateGameId() { 
    return Math.random().toString(36).substr(2, 6).toUpperCase(); 
}

function clearSavedData() { 
    localStorage.removeItem('chess_gameId'); 
    localStorage.removeItem('chess_playerName'); 
    localStorage.removeItem('chess_gameMode'); 
    localStorage.removeItem('chess_aiDifficulty'); 
    localStorage.removeItem('chess_boardTheme'); 
    alert('‚úÖ Donn√©es sauvegard√©es effac√©es'); 
    location.reload(); 
}

function initSocket() {
    socket = io();
    setInterval(() => { if (socket.connected) { socket.emit('ping'); } }, 25000);
    socket.on('pong', () => console.log('üèì Connexion active'));
    socket.on('connect', () => console.log('üîå Connect√© au serveur'));
    socket.on('disconnect', (reason) => { console.log('‚ùå D√©connect√©:', reason); updateGameStatus('‚ö†Ô∏è Connexion perdue... Reconnexion...'); });
    socket.on('reconnect', () => { console.log('üîÑ Reconnect√© au serveur'); if (gameId && localStorage.getItem('chess_playerName')) { socket.emit('join-game', { gameId, playerName: localStorage.getItem('chess_playerName') }); } });
    socket.on('player-assigned', (data) => { playerColor = data.color; currentGameState = data.gameState; createBoard(); updateBoard(); updateGameStatus(`Vous jouez les ${playerColor === 'white' ? 'Blancs' : 'Noirs'}`); });
    socket.on('game-start', (data) => { document.getElementById('whitePlayerName').textContent = data.white; document.getElementById('blackPlayerName').textContent = data.black; currentGameState = data.gameState; if (!document.getElementById('chessBoard').hasChildNodes()) { createBoard(); } updateBoard(); updateGameStatus('La partie commence !'); updatePlayerTurn(); });
    socket.on('ai-game-start', (data) => { document.getElementById('whitePlayerName').textContent = data.player; document.getElementById('blackPlayerName').textContent = `ü§ñ IA Niveau ${data.aiLevel}`; currentGameState = data.gameState; if (!document.getElementById('chessBoard').hasChildNodes()) { createBoard(); } updateBoard(); updateGameStatus('Partie contre IA commenc√©e ! Vous jouez les Blancs'); updatePlayerTurn(); });
    socket.on('move-made', (data) => { const moveText = data.isAIMove ? `ü§ñ IA joue: ${data.move.san}` : `üì® Coup re√ßu: ${data.move.san}`; console.log(moveText); currentGameState = data.gameState; moveHistory = data.moveHistory; updateBoard(); updateMoveHistory(); updatePlayerTurn(); clearSelection(); if (data.isAIMove) { updateGameStatus('ü§ñ IA a jou√© - √Ä votre tour !'); } });
    socket.on('move-history', (data) => { moveHistory = data; updateMoveHistory(); });
    socket.on('game-over', (data) => { updateGameStatus(`üèÅ ${data.result}`); clearSelection(); });
    socket.on('invalid-move', (message) => { console.log('‚ùå Coup invalide:', message); updateBoard(); clearSelection(); alert(message); });
    socket.on('player-reconnected', (data) => { console.log(`üîÑ ${data.playerName} s'est reconnect√©`); updateGameStatus(`‚úÖ ${data.playerName} s'est reconnect√© !`); setTimeout(() => { updatePlayerTurn(); }, 1000); });
    socket.on('player-temporarily-disconnected', (data) => { console.log(`‚ö†Ô∏è ${data.playerName} temporairement d√©connect√©`); updateGameStatus(`‚ö†Ô∏è ${data.message}`); });
    socket.on('player-disconnected', () => { updateGameStatus('‚ùå Un joueur s\'est d√©finitivement d√©connect√©'); });
    socket.on('spectator-mode', (data) => { currentGameState = data.gameState; moveHistory = data.moveHistory; updateBoard(); updateMoveHistory(); updateGameStatus('üëÄ Mode spectateur'); if (data.players.white) { document.getElementById('whitePlayerName').textContent = data.players.white; } if (data.players.black) { document.getElementById('blackPlayerName').textContent = data.players.black; } });
    socket.on('game-reset', (data) => { currentGameState = data.gameState; moveHistory = data.moveHistory; updateBoard(); updateMoveHistory(); updateGameStatus('Nouvelle partie commenc√©e !'); clearSelection(); });
}

// Remplacer la fonction createBoard() dans votre JavaScript :
// Remplacer les fonctions createBoard() et updateBoard() avec la correction des couleurs :

function createBoard() { 
    const board = document.getElementById('chessBoard'); 
    board.innerHTML = ''; 
    const isBlackPlayer = playerColor === 'black'; 
    
    console.log(`üéØ Cr√©ation √©chiquier pour: ${playerColor}`);
    
    if (isBlackPlayer) {
        // Joueur NOIR: rangs 1‚Üí8, files h‚Üía
        for (let rank = 1; rank <= 8; rank++) { 
            for (let file = 7; file >= 0; file--) { 
                const square = document.createElement('div'); 
                const squareId = String.fromCharCode(97 + file) + rank; 
                square.id = squareId; 
                
                // CORRECTION: Inverser la logique des couleurs
                square.className = `square ${(rank + file) % 2 === 0 ? 'light' : 'dark'}`; 
                
                square.addEventListener('click', () => handleSquareClick(squareId)); 
                board.appendChild(square); 
            } 
        }
    } else {
        // Joueur BLANC: rangs 8‚Üí1, files a‚Üíh
        for (let rank = 8; rank >= 1; rank--) { 
            for (let file = 0; file < 8; file++) { 
                const square = document.createElement('div'); 
                const squareId = String.fromCharCode(97 + file) + rank; 
                square.id = squareId; 
                
                // CORRECTION: Inverser la logique des couleurs
                square.className = `square ${(rank + file) % 2 === 0 ? 'light' : 'dark'}`; 
                
                square.addEventListener('click', () => handleSquareClick(squareId)); 
                board.appendChild(square); 
            } 
        }
    }
    
    updateBoard(); 
}

function updateBoard() { 
    if (!currentGameState) { 
        console.log('‚ö†Ô∏è Pas d\'√©tat de jeu disponible'); 
        return; 
    } 
    const board = fenToBoard(currentGameState); 
    
    for (let rank = 1; rank <= 8; rank++) { 
        for (let file = 0; file < 8; file++) { 
            const squareId = String.fromCharCode(97 + file) + rank; 
            const square = document.getElementById(squareId); 
            if (!square) continue; 
            
            const piece = board[8 - rank][file]; 
            
            // NOUVEAU: G√©rer l'affichage des pi√®ces avec couleurs
            if (piece && pieces[piece]) {
                square.textContent = pieces[piece];
                square.setAttribute('data-piece-color', piece === piece.toUpperCase() ? 'white' : 'black');
            } else {
                square.textContent = '';
                square.removeAttribute('data-piece-color');
            }
            
            square.className = `square ${(rank + file) % 2 === 0 ? 'light' : 'dark'}`; 
            
            if (moveHistory.length > 0) { 
                const lastMove = moveHistory[moveHistory.length - 1]; 
                if (squareId === lastMove.from || squareId === lastMove.to) { 
                    square.classList.add('last-move'); 
                } 
            } 
        } 
    }
    
    // NOUVEAU: Mettre √† jour les pi√®ces captur√©es
    updateCapturedPieces();
}
// Fonction utilitaire pour d√©boguer l'orientation (optionnelle)
function debugBoardOrientation() {
    console.log(`üéØ Joueur: ${playerColor || 'non d√©fini'}`);
    console.log(`üìã √âchiquier orient√© pour: ${playerColor === 'black' ? 'Noirs (rangs 8‚Üí1)' : 'Blancs (rangs 1‚Üí8)'}`);
    
    // Afficher les coordonn√©es des coins pour v√©rification
    const topLeft = document.querySelector('.chess-board').firstChild;
    const topRight = document.querySelector('.chess-board').children[7];
    const bottomLeft = document.querySelector('.chess-board').children[56];
    const bottomRight = document.querySelector('.chess-board').lastChild;
    
    console.log(`üìç Coins - TopLeft: ${topLeft?.id}, TopRight: ${topRight?.id}`);
    console.log(`üìç Coins - BottomLeft: ${bottomLeft?.id}, BottomRight: ${bottomRight?.id}`);
}

function fenToBoard(fen) { 
    const position = fen.split(' ')[0]; 
    const ranks = position.split('/'); 
    const board = []; 
    for (const rank of ranks) { 
        const row = []; 
        for (const char of rank) { 
            if (isNaN(char)) { 
                row.push(char); 
            } else { 
                for (let i = 0; i < parseInt(char); i++) { 
                    row.push(null); 
                } 
            } 
        } 
        board.push(row); 
    } 
    return board; 
}

function handleSquareClick(squareId) { 
    if (!selectedSquare) { 
        const square = document.getElementById(squareId); 
        if (square.textContent) { 
            selectedSquare = squareId; 
            square.classList.add('selected'); 
        } 
    } else { 
        if (selectedSquare !== squareId) { 
            makeMove(selectedSquare, squareId); 
        } 
        clearSelection(); 
    } 
}

function clearSelection() { 
    if (selectedSquare) { 
        const square = document.getElementById(selectedSquare); 
        square.classList.remove('selected'); 
        selectedSquare = null; 
    } 
    document.querySelectorAll('.square.highlight').forEach(sq => { 
        sq.classList.remove('highlight'); 
    }); 
}

function makeMove(from, to) { 
    console.log('üéØ Tentative de coup:', from, 'vers', to); 
    updateBoardOptimistic(from, to); 
    socket.emit('make-move', { gameId: gameId, move: { from, to } }); 
}

function updateBoardOptimistic(from, to) { 
    const fromSquare = document.getElementById(from); 
    const toSquare = document.getElementById(to); 
    if (fromSquare && toSquare) { 
        // Copier les attributs de couleur
        const pieceColor = fromSquare.getAttribute('data-piece-color');
        
        toSquare.textContent = fromSquare.textContent; 
        if (pieceColor) {
            toSquare.setAttribute('data-piece-color', pieceColor);
        }
        
        fromSquare.textContent = ''; 
        fromSquare.removeAttribute('data-piece-color');
        
        document.querySelectorAll('.last-move').forEach(sq => sq.classList.remove('last-move')); 
        fromSquare.classList.add('last-move'); 
        toSquare.classList.add('last-move'); 
    } 
}

function updateMoveHistory() { 
    const historyList = document.getElementById('moveHistoryList'); 
    historyList.innerHTML = ''; 
    for (let i = 0; i < moveHistory.length; i++) { 
        const move = moveHistory[i]; 
        const moveItem = document.createElement('div'); 
        moveItem.className = 'move-item'; 
        const moveNumber = Math.floor(i / 2) + 1; 
        const isWhiteMove = i % 2 === 0; 
        moveItem.innerHTML = `<span class="move-number">${moveNumber}${isWhiteMove ? '.' : '...'}</span><span class="move-notation">${move.move}</span>`; 
        historyList.appendChild(moveItem); 
    } 
    historyList.scrollTop = historyList.scrollHeight; 
}

function updateGameStatus(message) { 
    document.getElementById('gameStatus').innerHTML = `<h2>${message}</h2>`; 
}

function updatePlayerTurn() { 
    const fen = currentGameState; 
    const turn = fen.split(' ')[1]; 
    const whitePlayer = document.getElementById('whitePlayer'); 
    const blackPlayer = document.getElementById('blackPlayer'); 
    whitePlayer.classList.remove('active'); 
    blackPlayer.classList.remove('active'); 
    if (turn === 'w') { 
        whitePlayer.classList.add('active'); 
        updateGameStatus('Au tour des Blancs'); 
    } else { 
        blackPlayer.classList.add('active'); 
        updateGameStatus('Au tour des Noirs'); 
    } 
}

function newGame() { 
    if (confirm('√ätes-vous s√ªr de vouloir commencer une nouvelle partie ?')) { 
        socket.emit('new-game', gameId); 
    } 
}

function copyGameLink() { 
    const link = `${window.location.origin}/game/${gameId}`; 
    navigator.clipboard.writeText(link).then(() => { 
        alert('Lien copi√© dans le presse-papiers !'); 
    }); 
}

function leaveGame() { 
    if (confirm('√ätes-vous s√ªr de vouloir quitter la partie ?')) { 
        location.reload(); 
    } 
}

function updateCapturedPieces() {
    const captured = getCapturedPieces();
    
    const whiteCapturedDiv = document.getElementById('whiteCaptured');
    const blackCapturedDiv = document.getElementById('blackCaptured');
    
    if (whiteCapturedDiv) {
        whiteCapturedDiv.innerHTML = captured.white.map(piece => 
            `<span class="captured-piece white">${pieces[piece]}</span>`
        ).join('');
    }
    
    if (blackCapturedDiv) {
        blackCapturedDiv.innerHTML = captured.black.map(piece => 
            `<span class="captured-piece black">${pieces[piece]}</span>`
        ).join('');
    }
}

function getCapturedPieces() {
    // Pi√®ces de d√©part
    const startingPieces = {
        'K': 1, 'Q': 1, 'R': 2, 'B': 2, 'N': 2, 'P': 8,
        'k': 1, 'q': 1, 'r': 2, 'b': 2, 'n': 2, 'p': 8
    };
    
    // Compter les pi√®ces actuelles sur l'√©chiquier
    const currentPieces = {};
    Object.keys(startingPieces).forEach(piece => currentPieces[piece] = 0);
    
    if (currentGameState) {
        const board = fenToBoard(currentGameState);
        for (let rank = 0; rank < 8; rank++) {
            for (let file = 0; file < 8; file++) {
                const piece = board[rank][file];
                if (piece && currentPieces.hasOwnProperty(piece)) {
                    currentPieces[piece]++;
                }
            }
        }
    }
    
    // Calculer les pi√®ces captur√©es
    const captured = { white: [], black: [] };
    
    Object.keys(startingPieces).forEach(piece => {
        const missing = startingPieces[piece] - currentPieces[piece];
        const isWhitePiece = piece === piece.toUpperCase();
        
        for (let i = 0; i < missing; i++) {
            if (isWhitePiece) {
                captured.white.push(piece);
            } else {
                captured.black.push(piece);
            }
        }
    });
    
    return captured;
}


// Gestionnaire des √©v√©nements DOM
document.addEventListener('DOMContentLoaded', () => { 
    document.querySelectorAll('.btn-difficulty').forEach(btn => { 
        btn.addEventListener('click', (e) => { 
            e.preventDefault(); 
            document.querySelectorAll('.btn-difficulty').forEach(b => b.classList.remove('active')); 
            btn.classList.add('active'); 
            aiDifficulty = parseInt(btn.dataset.level); 
            const difficultyInfo = { 
                1: "Temps de r√©flexion: ~0.1s (Tr√®s facile)", 
                2: "Temps de r√©flexion: ~0.2s (Facile)", 
                3: "Temps de r√©flexion: ~0.5s (Moyen)", 
                4: "Temps de r√©flexion: ~2s (Difficile)", 
                5: "Temps de r√©flexion: ~5s (Expert)" 
            }; 
            document.getElementById('difficultyInfo').textContent = difficultyInfo[aiDifficulty]; 
        }); 
    }); 
});

// Gestionnaire de chargement de la page
window.addEventListener('load', () => { 
    const urlPath = window.location.pathname; 
    const match = urlPath.match(/\/game\/(.+)/); 
    if (match) { 
        document.getElementById('gameId').value = match[1]; 
    } 
    const savedGameId = localStorage.getItem('chess_gameId'); 
    const savedPlayerName = localStorage.getItem('chess_playerName'); 
    const savedGameMode = localStorage.getItem('chess_gameMode'); 
    if (savedGameId && savedPlayerName) { 
        if (savedGameMode === 'ai') { 
            document.getElementById('playerNameAI').value = savedPlayerName; 
            localStorage.removeItem('chess_gameId'); 
            localStorage.removeItem('chess_playerName'); 
            localStorage.removeItem('chess_gameMode'); 
            return; 
        } else { 
            document.getElementById('gameId').value = savedGameId; 
            document.getElementById('playerName').value = savedPlayerName; 
        } 
        const reconnectMessage = `Voulez-vous vous reconnecter √† la partie ${savedGameId} en tant que ${savedPlayerName} ?`; 
        if (confirm(reconnectMessage)) { 
            isReconnecting = true; 
            selectGameMode('multiplayer'); 
            joinGame(); 
        } else { 
            localStorage.removeItem('chess_gameId'); 
            localStorage.removeItem('chess_playerName'); 
            localStorage.removeItem('chess_gameMode'); 
        } 
    } 
});
</script>
</body>
</html>